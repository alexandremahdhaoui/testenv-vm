openapi: 3.0.3
info:
  title: testenv-vm Spec API
  version: 0.1.0
  description: OpenAPI schema for testenv-vm test environment specification.

paths: {}

components:
  schemas:
    Spec:
      type: object
      description: Top-level specification for a test environment.
      properties:
        stateDir:
          type: string
          description: Directory for persisting environment state.
        artifactDir:
          type: string
          description: Directory for storing artifacts (keys, logs, etc.).
        cleanupOnFailure:
          type: boolean
          description: Whether to clean up resources on failure. Defaults to true.
        imageCacheDir:
          type: string
          description: Directory for caching downloaded VM base images.
        defaultBaseImage:
          type: string
          description: Default base image to use for VMs. Can be a well-known reference or HTTPS URL.
        images:
          type: array
          description: VM base images to download and cache.
          items:
            $ref: '#/components/schemas/ImageResource'
        providers:
          type: array
          description: Available providers for resource provisioning.
          items:
            $ref: '#/components/schemas/ProviderConfig'
        defaultProvider:
          type: string
          description: Name of the default provider to use when not specified.
        keys:
          type: array
          description: SSH key pair resources to create.
          items:
            $ref: '#/components/schemas/KeyResource'
        networks:
          type: array
          description: Network infrastructure resources to create.
          items:
            $ref: '#/components/schemas/NetworkResource'
        vms:
          type: array
          description: Virtual machine resources to create.
          items:
            $ref: '#/components/schemas/VMResource'
      required:
        - providers

    ProviderConfig:
      type: object
      description: Provider configuration. Providers are MCP servers that implement resource provisioning.
      properties:
        name:
          type: string
          description: Unique identifier for this provider.
        engine:
          type: string
          description: Path to the provider binary or Go package.
        default:
          type: boolean
          description: Marks this provider as the default for resources without explicit provider.
        spec:
          type: object
          additionalProperties: true
          description: Provider-specific configuration passed during initialization.
      required:
        - name
        - engine

    ImageResource:
      type: object
      description: VM base image resource.
      properties:
        name:
          type: string
          description: Unique identifier for this image.
        spec:
          $ref: '#/components/schemas/ImageSpec'
      required:
        - name
        - spec

    ImageSpec:
      type: object
      description: Image-specific configuration.
      properties:
        source:
          type: string
          description: Image source - either a well-known reference or an HTTPS URL.
        sha256:
          type: string
          description: Expected SHA256 checksum of the image file.
        alias:
          type: string
          description: Optional alternative name for template references.
      required:
        - source

    KeyResource:
      type: object
      description: SSH key resource.
      properties:
        name:
          type: string
          description: Unique identifier for this key.
        provider:
          type: string
          description: Name of the provider to use. If empty, uses default provider.
        spec:
          $ref: '#/components/schemas/KeySpec'
        providerSpec:
          type: object
          additionalProperties: true
          description: Provider-specific configuration.
      required:
        - name
        - spec

    KeySpec:
      type: object
      description: Key-specific configuration.
      properties:
        type:
          type: string
          description: 'Key type: rsa, ed25519, ecdsa.'
        bits:
          type: integer
          description: Key size in bits.
        comment:
          type: string
          description: Optional comment for the public key.
        outputDir:
          type: string
          description: Directory to write key files to.
      required:
        - type

    NetworkResource:
      type: object
      description: Network resource.
      properties:
        name:
          type: string
          description: Unique identifier for this network.
        kind:
          type: string
          description: 'Network type: bridge, libvirt, dnsmasq, vpc, subnet, security-group.'
        provider:
          type: string
          description: Name of the provider to use. If empty, uses default provider.
        spec:
          $ref: '#/components/schemas/NetworkSpec'
        providerSpec:
          type: object
          additionalProperties: true
          description: Provider-specific configuration.
      required:
        - name
        - kind
        - spec

    NetworkSpec:
      type: object
      description: Network-specific configuration.
      properties:
        cidr:
          type: string
          description: Network CIDR (e.g., 192.168.100.1/24).
        gateway:
          type: string
          description: Gateway IP address.
        attachTo:
          type: string
          description: References another network resource (for layered networks).
        mtu:
          type: integer
          description: Maximum transmission unit size.
        dhcp:
          $ref: '#/components/schemas/DHCPSpec'
        dns:
          $ref: '#/components/schemas/DNSSpec'
        tftp:
          $ref: '#/components/schemas/TFTPSpec'

    DHCPSpec:
      type: object
      description: DHCP server configuration.
      properties:
        enabled:
          type: boolean
          description: Enables DHCP.
        rangeStart:
          type: string
          description: First IP in DHCP range.
        rangeEnd:
          type: string
          description: Last IP in DHCP range.
        leaseTime:
          type: string
          description: 'Lease time duration (e.g., 12h).'
      required:
        - enabled
        - rangeStart
        - rangeEnd

    DNSSpec:
      type: object
      description: DNS forwarding configuration.
      properties:
        enabled:
          type: boolean
          description: Enables DNS forwarding.
        servers:
          type: array
          description: DNS servers to forward to.
          items:
            type: string

    TFTPSpec:
      type: object
      description: TFTP server configuration for PXE boot.
      properties:
        enabled:
          type: boolean
          description: Enables TFTP server.
        root:
          type: string
          description: Directory for TFTP files.
        bootFile:
          type: string
          description: Default boot file (e.g., undionly.kpxe).
      required:
        - enabled
        - root
        - bootFile

    VMResource:
      type: object
      description: VM resource.
      properties:
        name:
          type: string
          description: Unique identifier for this VM.
        provider:
          type: string
          description: Name of the provider to use. If empty, uses default provider.
        spec:
          $ref: '#/components/schemas/VMSpec'
        providerSpec:
          type: object
          additionalProperties: true
          description: Provider-specific configuration.
      required:
        - name
        - spec

    VMSpec:
      type: object
      description: VM-specific configuration.
      properties:
        memory:
          type: integer
          description: Memory in MB.
        vcpus:
          type: integer
          description: Number of virtual CPUs.
        disk:
          $ref: '#/components/schemas/DiskSpec'
        network:
          type: string
          description: Name of the network resource to attach.
        cloudInit:
          $ref: '#/components/schemas/CloudInitSpec'
        boot:
          $ref: '#/components/schemas/BootSpec'
        readiness:
          $ref: '#/components/schemas/ReadinessSpec'
      required:
        - memory
        - vcpus
        - disk
        - network
        - boot

    DiskSpec:
      type: object
      description: VM disk configuration.
      properties:
        baseImage:
          type: string
          description: Path/URL to base image (QCOW2, AMI, etc.).
        size:
          type: string
          description: 'Disk size (e.g., 20G).'
      required:
        - size

    CloudInitSpec:
      type: object
      description: Cloud-init configuration.
      properties:
        hostname:
          type: string
          description: Hostname for the VM.
        users:
          type: array
          description: Users to create.
          items:
            $ref: '#/components/schemas/UserSpec'
        packages:
          type: array
          description: Packages to install.
          items:
            type: string
        writeFiles:
          type: array
          description: Files to write.
          items:
            $ref: '#/components/schemas/WriteFileSpec'
        runcmd:
          type: array
          description: Commands to run.
          items:
            type: string
        networkConfig:
          $ref: '#/components/schemas/CloudInitNetworkConfig'

    CloudInitNetworkConfig:
      type: object
      description: Cloud-init network settings using netplan version 2 format.
      properties:
        ethernets:
          type: array
          description: Ethernet interface configurations.
          items:
            $ref: '#/components/schemas/CloudInitEthernetConfig'

    CloudInitEthernetConfig:
      type: object
      description: Single ethernet interface configuration.
      properties:
        name:
          type: string
          description: Interface name pattern (e.g., ens2, en*, eth*).
        dhcp4:
          type: boolean
          description: Enables DHCP for IPv4. Defaults to false if addresses is set.
        addresses:
          type: array
          description: Static IP addresses in CIDR notation.
          items:
            type: string
        gateway4:
          type: string
          description: IPv4 gateway address.
        nameservers:
          $ref: '#/components/schemas/CloudInitNameservers'
      required:
        - name

    CloudInitNameservers:
      type: object
      description: DNS server configuration.
      properties:
        addresses:
          type: array
          description: DNS server IP addresses.
          items:
            type: string

    WriteFileSpec:
      type: object
      description: File to write via cloud-init.
      properties:
        path:
          type: string
          description: File path.
        content:
          type: string
          description: File content.
        permissions:
          type: string
          description: 'File permissions (e.g., 0644).'
      required:
        - path
        - content

    UserSpec:
      type: object
      description: User to create via cloud-init.
      properties:
        name:
          type: string
          description: Username.
        sudo:
          type: string
          description: 'Sudo rules (e.g., ALL=(ALL) NOPASSWD:ALL).'
        sshAuthorizedKeys:
          type: array
          description: Public keys to add to authorized_keys.
          items:
            type: string
      required:
        - name

    BootSpec:
      type: object
      description: Boot options configuration.
      properties:
        order:
          type: array
          description: 'Boot device order: network, hd, cdrom.'
          items:
            type: string
        firmware:
          type: string
          description: 'Firmware type: bios or uefi.'
      required:
        - order

    ReadinessSpec:
      type: object
      description: Readiness checks configuration.
      properties:
        ssh:
          $ref: '#/components/schemas/SSHReadinessSpec'

    SSHReadinessSpec:
      type: object
      description: SSH readiness check configuration.
      properties:
        enabled:
          type: boolean
          description: Enables SSH readiness check.
        timeout:
          type: string
          description: 'Timeout for SSH to become available (e.g., 5m).'
        user:
          type: string
          description: User for SSH connection.
        privateKey:
          type: string
          description: Private key path (can use template).
      required:
        - enabled
        - timeout

    ResourceRef:
      type: object
      description: Uniquely identifies a resource.
      properties:
        kind:
          type: string
          description: 'Resource type: vm, network, key.'
        name:
          type: string
          description: User-defined identifier.
        provider:
          type: string
          description: Provider that manages this resource.
      required:
        - kind
        - name
